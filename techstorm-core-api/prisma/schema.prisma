// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Enums
enum UserRole {
  ADMIN
  MENTOR
  MENTEE
}

enum UserStatus {
  ACTIVE
  SUSPENDED
}

enum CourseStatus {
  DRAFT
  REVIEW
  PUBLISHED
  ARCHIVED
}

enum MeetingStatus {
  SCHEDULED
  REQUESTED
  COMPLETED
  CANCELLED
}

// Models

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?   // Hashed
  role          UserRole  @default(MENTEE)
  status        UserStatus @default(ACTIVE)
  
  // Profile Fields
  title         String?   // e.g. "Senior Software Engineer"
  bio           String?   @db.Text
  linkedinUrl   String?
  githubUrl     String?
  twitterUrl    String?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  coursesTeaching Course[]      @relation("InstructorCourses")
  enrollments     Enrollment[]
  comments        Comment[]
  progress        LessonProgress[]
  quizAttempts    QuizAttempt[]
  submissions     AssignmentSubmission[]
  meetings        Meeting[] @relation("MentorMeetings")
  menteeMeetings  Meeting[] @relation("MenteeMeetings")
}

model Course {
  id          String       @id @default(cuid())
  title       String
  description String?      @db.Text
  image       String?
  price       Float?
  category    String?
  status      CourseStatus @default(DRAFT)
  
  instructorId String
  instructor   User   @relation("InstructorCourses", fields: [instructorId], references: [id], onDelete: Cascade)

  modules     Module[]
  enrollments Enrollment[]
  meetings    Meeting[]
  invitations CourseInvitation[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Meeting {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text
  startTime   DateTime
  link        String?   // Google Meet, Zoom, Teams URL - Optional for requests
  
  courseId    String
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  mentorId    String
  mentor      User     @relation("MentorMeetings", fields: [mentorId], references: [id], onDelete: Cascade)

  menteeId    String?
  mentee      User?    @relation("MenteeMeetings", fields: [menteeId], references: [id], onDelete: Cascade)

  status      MeetingStatus @default(SCHEDULED)

  createdAt   DateTime @default(now())
}

model Module {
  id       String   @id @default(cuid())
  title    String
  position Int
  
  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  lessons  Lesson[]
}

enum VideoType {
  YOUTUBE
  UPLOAD
}

model Lesson {
  id          String  @id @default(cuid())
  title       String
  description String? @db.Text
  position    Int
  isFree      Boolean @default(false)
  duration    Int?    // In seconds
  
  videoType   VideoType @default(YOUTUBE)
  videoUrl    String? // Mux or YouTube URL or Supabase Storage URL
  
  moduleId    String
  module      Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  userProgress LessonProgress[]
  quizzes      Quiz[]
  assignments  Assignment[]
  attachments  LessonAttachment[]
}

model LessonAttachment {
  id        String   @id @default(cuid())
  name      String
  url       String
  type      String   // PDF, DOC, ZIP, etc.
  size      Int?     // In bytes
  
  lessonId  String
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
}

model Quiz {
  id        String   @id @default(cuid())
  title     String
  lessonId  String
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  questions Question[]
  attempts  QuizAttempt[]
}

model Question {
  id          String   @id @default(cuid())
  text        String
  quizId      String
  quiz        Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  options     Option[]
  correctAnswer String // The text of the correct option
}

model Option {
  id         String   @id @default(cuid())
  text       String
  questionId String
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model Assignment {
  id          String   @id @default(cuid())
  title       String
  description String   @db.Text
  lessonId    String
  lesson      Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  submissions AssignmentSubmission[]
}

model QuizAttempt {
  id          String   @id @default(cuid())
  userId      String
  quizId      String
  score       Int
  totalQuestions Int
  completedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)
}

enum SubmissionStatus {
  PENDING
  GRADED
}

model AssignmentSubmission {
  id           String           @id @default(cuid())
  userId       String
  assignmentId String
  content      String           @db.Text // Text submission or link
  fileUrl      String?          // Optional file upload
  status       SubmissionStatus @default(PENDING)
  grade        String?          // e.g., "A", "95/100"
  feedback     String?          @db.Text
  submittedAt  DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
}

model LessonProgress {
  id          String  @id @default(cuid())
  userId      String
  lessonId    String
  isCompleted Boolean @default(false)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
}

model Enrollment {
  id        String   @id @default(cuid())
  userId    String
  courseId  String
  enrolledAt DateTime @default(now())
  
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())
  
  userId    String
  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Event {
  id          String   @id @default(cuid())
  title       String
  description String   @db.Text
  date        DateTime
  location    String   // Venue name or meeting link
  image       String?  // Optional thumbnail
  isVirtual   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model GlobalSetting {
  id                String  @id @default("system_settings")
  maintenanceMode   Boolean @default(false)
  platformName      String  @default("TechStorm Global")
  supportEmail      String  @default("Info@techstormglobal.com")
  updatedAt         DateTime @updatedAt
}

model CourseInvitation {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  expiresAt DateTime
}
  
model GalleryImage {
  id        String   @id @default(cuid())
  url       String
  title     String?
  description String?
  category  String   @default("events")
  createdAt DateTime @default(now())
}

model TeamMember {
  id        String   @id @default(cuid())
  name      String
  role      String
  bio       String?  @db.Text
  image     String
  order     Int      @default(0)
  linkedinUrl String?
  twitterUrl  String?
  youtubeUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
